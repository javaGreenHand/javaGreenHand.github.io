---
title: SQL优化及技巧
tags: [MySQL,Oracle]
categories: 数据库
---

开发中经常遇到以下情况：
* sql执行非常耗时
* 行转列或列转行

故记录一下解决思路，并记录一些常用函数
<!-- more -->

# SQL优化（MySQL）
## 索引
* 类型
    * unique(唯一索引)：不可以出现相同的值，可以有NULL值
    * normal(普通索引)：允许出现相同的索引内容
    * primary key(主键索引)：不允许出现相同的值
    * full text(全文索引)：可以针对值中的某个单词，但效率确实不敢恭维
    * 组合索引：实质上是将多个字段建到一个索引里，列值的组合必须唯一
* 底层实现类别
    * B树（二叉树）、B-树、B+树（重点掌握）、B*树
    * 哈希索引
        * 自适应哈希索引：Innodb存储引擎会监控对表上各索引页的查询。如果观察到建立哈希索引可以带来速度提升，则建立哈希索引，称之为自适应哈希索引（AHI），AHI是通过缓冲池的B+树页构造而来，因此建立的速度很快，而且不需要对整张表构建哈希索引。Innodb存储引擎会自动根据访问的频率和模式来自动地为某些热点页建立哈希索引
* 原理
通过不断地缩小想要获取数据的范围来筛选出最终想要的结果，同时把随机的事件变成顺序的事件，也就是说，有了这种索引机制，我们可以总是用同一种查找方式来锁定数据。

## 存储引擎
* MyISAM和InnoDB主要区别：
   * MyISAM是非事务安全型的，而InnoDB是事务安全型的。
   * MyISAM锁的粒度是表级，而InnoDB支持行级锁定。
   * MyISAM支持全文类型索引，而InnoDB不支持全文索引。
   * MyISAM相对简单，所以在效率上要优于InnoDB，小型应用可以考虑使用MyISAM。
   * MyISAM表是保存成文件的形式，在跨平台的数据转移中使用MyISAM存储会省去不少的麻烦。
   * InnoDB表比MyISAM表更安全，可以在保证数据不会丢失的情况下，切换非事务表到事务表（alter table tablename type=innodb）。

* MyISAM和InnoDB的应用场景
   * MyISAM管理非事务表。它提供高速存储和检索，以及全文搜索能力。如果应用中需要执行大量的SELECT查询，那么MyISAM是更好的选择。
   * InnoDB用于事务处理应用程序，具有众多特性，包括ACID事务支持。如果应用中需要执行大量的INSERT或UPDATE操作，则应该使用InnoDB，这样可以提高多用户并发操作的性能。

## 查看计划
使用explain来查看sql的执行计划，其中type（使用到的索引类型）比较重要：

| 类型 | 说明 |
| --- | ------ |
| system | 根据主键或者唯一索引进行的查询 |
| const | 根据主键或者唯一索引进行的查询 |
| eq_ref | 使用唯一索引的前缀扫描 |
| ref | 使用非唯一性索引或者唯一索引的前缀扫描 |
| range | 索引范围扫描 |
| index | 索引全扫描 |
| all | 全表扫描 |
| NULL | MYSQL不用访问表或者索引就直接能到结果 |

从最好到最差依次是：
`system > const > eq_ref > ref > range > index > all`
一般来说，保证查询至少要达到range，最好达到ref

## 优化技巧
首先要精简SQL（多余的表关联、重复的表访问、冗余的关联（过滤）条件、不必要的DISTINCT\ORDER BY\GROUP BY、曲折的访问路径）,其次驱动表的数据量要足够的少，最后集合操作是二维关系数据库引擎在数据处理时的根本。因此一个高效的SQL一定有一个合理的集合运算结构。根据业务需求，结合代码逻辑，有的时候需要将代码片通过子查询封装；而有的时候又需要将子查询合并到主查询中；有的时候需要将大集合根据业务逻辑切片成多个小的集合；有的时候又需要将若干个小的集合预先合并成大集合。总之，在进行SQL（优化）时，要用集合的思维指导SQL（优化）。
虽然索引大大提高了查询速度，同时却会降低更新表的速度，因为索引也要同时保存。使用索引的注意事项：
* 建议使用索引的列：在where和join中出现的列、经常进行select操作的列
* 索引列的要求：不会包含NULL、值比较唯一、非text、image和bit数据类型的列
* 避免索引失效：不使用like‘%aaa%’、不使用NOT IN 、<>、！=操作、不要在列上进行运算、join操作时主键和外键的数据类型要相同

# 行列互转(Oracle)
[官方文档地址](http://www.oracle.com/technetwork/cn/articles/11g-pivot-101924-zhs.html)
* pivot：行转列
* unpivot：列转行
